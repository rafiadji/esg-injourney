{% extends 'base.html' %}

{% block title %}
  Data
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="//cdn.datatables.net/fixedcolumns/5.0.1/css/fixedColumns.dataTables.css" />
  <style>
    /* Untuk mengatasi masalah scrollX dan fixed columns */

  </style>
  <!-- Ganti dengan versi terbaru yang kompatibel -->
<!-- <link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/2.0.0/css/rowGroup.dataTables.min.css"> -->

<link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.5.1/css/rowGroup.dataTables.min.css">
<style>
  .indikasi-kematangan-col{
    padding-left:50px !important;
  }
</style>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-sm-flex align-items-center justify-content-between">
        <h4 class="mb-sm-0">Data Kertas Kerja ESG Level Sustainability</h4>

        {% comment %} <div class="page-title-right">
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item">
              <a href="javascript: void(0);">Advance UI</a>
            </li>
            <li class="breadcrumb-item active">Animation</li>
          </ol>
        </div> {% endcomment %}
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-header border-0">
          <div class="d-flex align-items-center">
            <h5 class="card-title mb-0 flex-grow-1">List Kertas Kerja</h5>
            <div class="flex-shrink-0">
              <div class="d-flex flex-wrap gap-2">
                  <select id="pillar-select" class="form-control">
                    <option value="" selected>Pilih Pilar</option>
                    <option value="gov">Governance</option>
                    <option value="env">Environment</option>
                    <option value="soc">Social</option>
                  </select>
                {% comment %} <button class="btn btn-primary" onclick="add_fleet()"><i class="ri-add-line align-bottom me-1"></i> Add Fleet</button> {% endcomment %}
              </div>
            </div>
          </div>
        </div>
        <style>
          /* Striping hanya untuk td yang BUKAN fixed */
          td.custom-striped {
            background-color: #fbfbfb !important;
          }

          tr.group-header {
            background-color: #f8f9fa !important;
            font-weight: bold !important;
            border-top: 2px solid #dee2e6 !important;
            border-bottom: 1px solid #dee2e6 !important;
          }

          tr.group-header td {
            padding: 10px 15px !important;
          }

          /* Pastikan group header muncul di atas fixed columns */
          tr.group-header {
            position: relative;
            z-index: 100;
          }

          .dtfc-fixed-left {
            z-index: 1;
          }

          /* Optional: hover tetap seluruh baris */
          /* #matlev-table tbody tr:hover td {
            background-color: #d0edf0 !important;
          } */


          /* Hover tetap sinkron seluruh baris jika kamu mau */
          

          .btn{
            border-radius: 4px;;
          }
        </style>
        <div class="card-body">
          <table class="align-middle table table-bordered " id="matlev-table">
            <thead>
              <tr>
                <th>Indikator</th>
                <th>No</th>
                <th>Kriteria Sustainability</th>
                <th>Indikasi Kematangan</th>
                <th>Level</th>
                <th>Jenis Evidence</th>
                <th>Tipe Data</th>
                <th>PIC</th>
                <th>Level Pencapaian</th>
                <th>Bobot Level</th>
                <th>Total Level</th>
                <th>Status</th>
                <th>Last Update</th>
              </tr>
            </thead>
            <tbody>
              {% load humanize %}
              {% now "Y-m-d" as today %}
              {% for md in matlev_detail %}
              <tr>
                <td>{{ md.kriteria.indicator.pillar }}</td>
                <td style="white-space: nowrap;">{{ md.kriteria.indicator.indicator }}</td>
                <td>{{ md.kriteria.number }}</td>
                <td style="white-space: nowrap;">{{ md.kriteria.kriteria }}</td>
                <td>{{ md.maturity }}</td>
                <td>{{ md.level }}
                   
                </td>
                <td>{{ md.evidence }}</td>
                <td style="white-space: nowrap;">
                  {% if md.data_type == 'upload' %}
                  Dokumen
                  {% else %}
                  Form 
                  
                  {% endif %}
                  <br />
                  <a href="data/detail/{{md.id}}" class="btn btn-light waves-effect text-info py-1 px-2"><i class="fi fi-rr-folder align-middle" style="color: #00A2E9;"></i> Buka </a>
                </td>
                <td>{{ md.pic}}</td>
                <td style="text-align: center;">{{ md.kriteria.level_get }}

                  
                  {% if request.user.is_superuser or request.user.is_staff %}
                  <br />
                   <a href="javascript:;" onclick="edit_level({{md.kriteria_id}},{{ md.kriteria.level_get }})" class="btn btn-light waves-effect px-2 py-1 text-info"><i class="fi fi-rr-edit align-middle" style="color: #00A2E9;"></i> Edit</a>
                  {% endif %}
                </td>
                <td style="text-align: center;">{{ md.kriteria.level_weight }}
                  
                  {% if request.user.is_superuser or request.user.is_staff %}
                  <br />
                    <a href="javascript:;" onclick="edit_weight({{md.kriteria_id}},{{ md.kriteria.level_weight }})" class=" px-2 py-1 text-info btn btn-light waves-effect"><i class="fi fi-rr-edit align-middle" style="color: #00A2E9;"></i> Edit</a>
                  {% endif %}
                </td>
                <td style="text-align: center;">{{ md.kriteria.level_sum }}</td>
                <td style="white-space: nowrap;">
                  {% if md.status == 'belum' %}
                    <span class="status-belum"> Belum </span>
                  {% elif md.status == 'submitted' %}
                    
                    <span class="status-submitted"> Submitted </span>
                  {% elif md.status == 'revisi' %}

                    <span class="status-revisi"> Perlu Revisi </span>
                  {% elif md.status == 'verified' %}

                    <span class="status-verified"> Verified </span>
                  {% endif %}
                  <br />
                  <a href="javascript:;" onclick="detail_status({{md.id}},{{md.kriteria.level_get}})" class="mt-3 btn btn-light waves-effect px-2 py-1 text-info"><i class="fi fi-rr-edit align-middle" style="color: #00A2E9;"></i> Edit</a>
                  
                </td>
                <td>
                  {% if md.last_update %}
                    {{md.last_update}} oleh {{md.last_user.first_name}} {{md.last_user.last_name}}
                  {% endif %}
                </td>
                <td class="
                  tanggal_due_date
                ">{{ md.due_date|default:"-"}}  </td>
                
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div id="modal-detail" class="modal fade" tabindex="-1" aria-labelledby="modalDetailLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form action="" method="post">
          {% csrf_token %}
          <input type="hidden" id="maturity_id" name="maturity_id">
          <div class="modal-header">
            <h5 class="modal-title" id="modalDetailLabel"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="mb-3 col-6">
                <label for="pillar_select" class="form-label">Indikasi Kematangan</label>
                <textarea class="form-control-plaintext" id="modal_maturity" readonly></textarea>
              </div>
              <div class="mb-3 col-6">
                <label for="indicator_select" class="form-label">Level</label>
                <input type="text" class="form-control-plaintext" id="modal_level" readonly>
              </div>
              <div class="mb-3 col-6">
                <label for="pillar_select" class="form-label">Jenis Evidence</label>
                <textarea class="form-control-plaintext" id="modal_evidence" readonly></textarea>
              </div>
              <div class="mb-3 col-6">
                <label for="indicator_select" class="form-label">Tipe Data</label>
                <input type="text" class="form-control-plaintext" id="modal_type_data" readonly>
              </div>
              <div class="mb-3 col-12">
                <label for="pic_select" class="form-label">Daftar PIC</label>
                <table class="table align-middle table-bordered table-strip mb-0" id="pic-table">
                  <thead>
                    <tr>
                      <th>PIC</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
              <div class="mb-3 col-6">
                <label class="form-label col-12">Status</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status" value="belum" id="belum" 
                          disabled>
                    <label class="form-check-label" for="belum">
                        Belum
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status" value="submitted" id="submitted" 
                          disabled>
                    <label class="form-check-label" for="submitted">
                        Submitted
                    </label>
                </div>

                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status" value="verified" id="verified"
                          disabled>
                    <label class="form-check-label" for="verified">
                        Verified
                    </label>
                </div>
                
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="status" value="revisi" id="revisi"
                          {% if not request.user.is_superuser and not request.user.is_staff %}disabled{% endif %}>
                    <label class="form-check-label" for="revisi">
                        Perlu Revisi
                    </label>
                </div>
            </div>
              <div class="mb-3 col-6">
                <label for="modal_due_date" class="form-label">Due Date</label>
                <input type="date" class="form-control" id="modal_due_date" name="due_date">
              </div>
              
              <div id="keteranganContainer" style="display: none;" class="col-6">
                  <label for="keterangan" class="form-label">Keterangan Revisi</label>
                  <textarea class="form-control" id="keterangan" name="keterangan" rows="3"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-light text-dark" data-bs-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-primary">
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script src="assets/js/dataTables.rowsGroup.js"></script>
  <script src="//cdn.datatables.net/fixedcolumns/5.0.1/js/dataTables.fixedColumns.js"></script>
  <script src="//cdn.datatables.net/fixedcolumns/5.0.1/js/fixedColumns.dataTables.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Ganti dengan versi yang valid dan tersedia -->
<script src="https://cdn.datatables.net/rowgroup/1.5.1/js/dataTables.rowGroup.min.js"></script>
  <script>
    const choice_option = {
      searchResultLimit: 20,
      shouldSort: false
    }
    const pillar_select = new Choices('#pillar-select', choice_option)

    var table_pic = $('#pic-table').DataTable({
      ordering: false,
      paging: false,
      searching: false
    })
    
    var table = $('#matlev-table')
      .DataTable({
        scrollX: true,
        ordering: false,
        columns: [
          {
            name: 'pillar',
            title: 'Pillar',
            width: '20px'
          },
          {
            name: 'indikator',
            title: 'Indikator',
            width: '250px',
            visible:false
          },
          {
            name: 'no',
            title: 'No',
            width: '20px',
            visible:false
          },
          {
            name: 'kriteria',
            title: 'Kriteria Sustainability',
            width: '50px',
            visible:false
          },
          {
            title: 'Indikasi Kematangan',
            width: '250px',
            className: 'indikasi-kematangan-col'
          },
          {
            title: 'Level',
            width: '20px'
          },
          {
            title: 'Jenis Evidence',
            width: '250px'
          },
          {
            title: 'Tipe Data',
            width: '50px'
          },
          {
            name: 'pic',
            title: 'PIC',
            width: '100px'
          },
          {
            name: 'levelcapai',
            title: 'Level Pencapaian',
            width: '50px'
          },
          {
            name: 'bobot',
            title: 'Bobot Level',
            width: '60px'
          },
          {
            name: 'totallevel',
            title: 'Total Level',
            width: '50px'
          },
          {
            title: 'Status',
            width: '100px'
          },
          {
            title: 'Last Update',
            width: '100px'
          },
          {
            title: 'Due Date',
            width: '100px'
          }
        ],
        rowsGroup: [ 'indikator:name','no:name', 'kriteria:name', 'pic:name', 'levelcapai:name', 'bobot:name', 'totallevel:name'],
        fixedColumns: {
          start: 1
        },
        columnDefs: [
        {
          target: 0,
          visible:false
        }
      ],
      rowGroup: {
        dataSrc: [1,3], // Gunakan nama kolom sebagai referensi
        startRender: function(rows, group, level) {
          // console.log(rows,this)
          var colCount = $('#matlev-table thead th').length;
    
          if (level === 0) {
            // Group Indikator (level utama)
            return $('<tr class="group-header-indikator">')
              .append('<td style="font-size:16px;position:sticky;left:0;border-right: 1px solid #F8F9FA;" colspan=2 >' + group + '</td><td colspan="' + (colCount-2) + '"></td>');
          }
          else if (level === 1) {
            // Group Kriteria (sub-level)
            // Ambil nomor dari row pertama dalam group ini
            var firstRowData = rows.data()[0];
            var nomor = firstRowData[2]; // Index 2 untuk kolom "No"
            
            return $('<tr class="group-header-kriteria">')
              .append('<td style="padding-left:30px !important;;position:sticky;left:0;border-right: 1px solid #F8F9FA;" colspan=2>' + nomor + '. ' + group + '</td><td colspan="' + (colCount-2) + '"></td>');
          }
        },
        endRender: null,
        className: 'group-header'
      },
      
      initComplete: function() {
            // const today = moment().startOf('day'); // Tanggal hari ini (00:00:00)
            
            // $('td.tanggal_due_date').each(function() {
            //     const dateText = $(this).text().trim();
                
            //     // Skip jika kosong atau "-"
            //     if (!dateText || dateText === '-') return;
                
            //     // Parse tanggal dengan format "July 1, 2025"
            //     const dueDate = moment(dateText, 'MMMM D, YYYY');
                
            //     if (!dueDate.isValid()) {
            //         console.warn('Format tanggal tidak valid:', dateText);
            //         return;
            //     }
                
            //     // Hitung selisih hari (hari ini - due date)
            //     const daysDiff = dueDate.diff(today, 'days');
                
            //     // Tentukan class CSS
            //     if (daysDiff < 0) {
            //         $(this).addClass('bg-danger text-white');  // Sudah lewat deadline
            //     } else if (daysDiff <= 7) {
            //         $(this).addClass('bg-warning text-white'); // Deadline dalam 7 hari
            //     }
            // });

            setTimeout(function() {
                // applyStripedStyles();
                // Panggil adjust setelah styling
                table.columns.adjust().draw();
            }, 300);
        },
          drawCallback: function(settings) {
            $('#matlev-table tbody tr').each(function(index, row) {
              const isEven = index % 2 === 0;

              // Hapus semua striping dulu
              $(row).find('td').removeClass('custom-striped');

              if (isEven) {
                // Tambahkan striping ke kolom non-fixed
                $(row).find('td:not(.dtfc-fixed-left)').addClass('custom-striped');

                // Tambahkan striping ke kolom fixed terakhir saja
                const fixedTds = $(row).find('td.dtfc-fixed-left');
                fixedTds.last().addClass('custom-striped');

                
              }

              const today = moment().startOf('day');
              const dueDateColumnIndex = 10; // Sesuaikan dengan index kolom due date
            
              const dueDateCell = $(row).find('td').eq(dueDateColumnIndex);
              const status = $(row).find('td').eq(dueDateColumnIndex-2);
              const dateText = dueDateCell.text().trim();
              const spanContent = $(status).find('span').text().trim();
              console.log(spanContent)

              if(spanContent == 'Belum' || spanContent == 'Perlu Revisi'){
                dueDateCell.removeClass('bg-danger bg-warning text-white');
                
                if (!dateText || dateText === '-') return;
                
                const dueDate = moment(dateText, 'MMMM D, YYYY');
                // console.log(dateText, dueDate)
                if (!dueDate.isValid()) return;
                
                const daysDiff = dueDate.diff(today, 'days');
                
                if (daysDiff < 0) {
                  dueDateCell.removeClass('custom-striped')
                  dueDateCell.addClass('bg-danger text-white');
                } else if (daysDiff <= 7) {

                  dueDateCell.removeClass('custom-striped')
                  dueDateCell.addClass('bg-warning text-white');
                }
              }
            });

            
  // Proses semua row yang terlihat
            
            
          }



      })
    pillar_select.passedElement.element.addEventListener('change',function(event) {
        table.column(0).search(event.detail.value).draw();
      },
      false,
    );

    // Tambahkan ini untuk memastikan fungsi dipanggil
    // table.on('draw.dt', function() {
    //     console.log('Table redrawn - applying styles');
    //     setTimeout(applyStripedStyles, 50);
    // });

    // table.on('draw.dtfc', function() {
    //     console.log('FixedColumns redrawn - applying styles');
    //     setTimeout(applyStripedStyles, 50);
    // });
    const urlParams = new URLSearchParams(window.location.search);
    const kriteria = urlParams.get('kriteria');
    if(kriteria != null){
      console.log(kriteria)
      table.column(3).search(kriteria).draw();
    }

    function detail_status(id,level_get){
      $.ajax({
        url: `data/get_detail_status/${id}`,
        dataType: 'json',
        async: true,
        success: (res) => {
          dt = res.data
          $('#maturity_id').val(id)
          $('#modal_maturity').val(dt.maturity)
          $('#modal_level').val(dt.level)
          $('#modal_evidence').val(dt.evidence)
          $('#modal_due_date').val(dt.due_date)
          if(dt.data_type == 'upload'){
            $('#modal_type_data').val('Upload Dokumen')
          }else {
            $('#modal_type_data').val('Pengisian Form')
          }
          if(dt.status == "revisi"){
            $('#revisi').prop('checked', true).trigger('change');
            $('#keteranganContainer').css('display','block');
            $('#keterangan').val(dt.keterangan);
          }else{
            
            $('#'+dt.status).attr('checked',true)
            
            $('#keteranganContainer').css('display','none');
            $('#keterangan').val(dt.keterangan);
          }

          // if(dt.status == 'on progress'){
            
          // }else {
          // }
          get_pic_list(id)
          $('#modal-detail').modal('show')
        }
      })
    }

    function get_pic_list(id){
      $.ajax({
        url: `data/get_detail_pic/${id}`,
        dataType: 'json',
        async: true,
        success: (res) => {
          table_pic.clear().draw()
          for (var i = 0; i < res.data.length; i++){
            const dt = res.data[i]
            table_pic.row.add([
              dt.pic__pic
            ]).draw()
          }
        }
      })
    }
  function edit_level(id, current_level) {
      // Membuat modal HTML
      var modalHTML = `
      <div class="modal fade" id="editLevelModal" tabindex="-1" aria-labelledby="editLevelModalLabel" aria-hidden="true">
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      <h5 class="modal-title" id="editLevelModalLabel">Verifikasi Level</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <form id="editLevelForm">
                          <input type="hidden" id="editLevelId" value="${id}">
                          <div class="mb-3">
                              <label for="editLevelValue" class="form-label">Level</label>
                              <input type="text" class="form-control" id="editLevelValue" value="${current_level}">
                          </div>
                      </form>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="button" class="btn btn-primary" onclick="submitLevelEdit()">Simpan Perubahan</button>
                  </div>
              </div>
          </div>
      </div>
      `;
      
      // Menambahkan modal ke body
      $('body').append(modalHTML);
      
      // Menampilkan modal
      var modal = new bootstrap.Modal(document.getElementById('editLevelModal'));
      modal.show();
      $('#editLevelModal').on('shown.bs.modal', function () {
        $('#editLevelValue').focus();
    });
      // Membersihkan modal setelah ditutup
      $('#editLevelModal').on('hidden.bs.modal', function () {
          $(this).remove();
      });
  }
  function edit_weight(id, current_weight) {
      // Membuat modal HTML
      var modalHTML = `
      <div class="modal fade" id="editWeightModal" tabindex="-1" aria-labelledby="editWeightModalLabel" aria-hidden="true">
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      <h5 class="modal-title" id="editWeightModalLabel">Ubah Bobot</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <form id="editWeightForm">
                          <input type="hidden" id="editWeightId" value="${id}">
                          <div class="mb-3">
                              <label for="editWeightValue" class="form-label">Bobot</label>
                              <input type="text" class="form-control" id="editWeightValue" value="${current_weight}">
                          </div>
                      </form>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                      <button type="button" class="btn btn-primary" onclick="submitWeightEdit()">Simpan Perubahan</button>
                  </div>
              </div>
          </div>
      </div>
      `;
      
      // Menambahkan modal ke body
      $('body').append(modalHTML);
      
      // Menampilkan modal
      var modal = new bootstrap.Modal(document.getElementById('editWeightModal'));
      modal.show();
      $('#editWeightModal').on('shown.bs.modal', function () {
        $('#editWeightValue').focus();
    });
      // Membersihkan modal setelah ditutup
      $('#editWeightModal').on('hidden.bs.modal', function () {
          $(this).remove();
      });
  }
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function submitLevelEdit() {
    var id = $('#editLevelId').val();
    var newLevel = $('#editLevelValue').val();
    
    if (!newLevel) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Level tidak boleh kosong',
            confirmButtonColor: '#3085d6',
        });
        return;
    }
    
    $.ajax({
        url: '/data/update_level_get',
        method: 'POST',
        contentType: 'application/json',
        headers: {
            "X-CSRFToken": getCookie('csrftoken')
        },
        data: JSON.stringify({
            id: id,
            level: newLevel
        }),
        success: function(res) {
            $('#editLevelModal').modal('hide');
            
            if (res.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Sukses',
                    text: res.message,
                    confirmButtonColor: '#3085d6',
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.reload();
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal',
                    text: res.message,
                    confirmButtonColor: '#3085d6',
                });
            }
        },
        error: function(xhr) {
            $('#editLevelModal').modal('hide');
            let errorMsg = xhr.responseJSON?.message || 'Terjadi kesalahan';
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: errorMsg,
                confirmButtonColor: '#3085d6',
            });
        }
    });
}
function submitWeightEdit() {
    var id = $('#editWeightId').val();
    var newWeight = $('#editWeightValue').val();
    
    if (!newWeight) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Weight tidak boleh kosong',
            confirmButtonColor: '#3085d6',
        });
        return;
    }
    
    $.ajax({
        url: '/data/update_weight',
        method: 'POST',
        contentType: 'application/json',
        headers: {
            "X-CSRFToken": getCookie('csrftoken')
        },
        data: JSON.stringify({
            id: id,
            weight: newWeight
        }),
        success: function(res) {
            $('#editWeightModal').modal('hide');
            
            if (res.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Sukses',
                    text: res.message,
                    confirmButtonColor: '#3085d6',
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.reload();
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal',
                    text: res.message,
                    confirmButtonColor: '#3085d6',
                });
            }
        },
        error: function(xhr) {
            $('#editWeightModal').modal('hide');
            let errorMsg = xhr.responseJSON?.message || 'Terjadi kesalahan';
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: errorMsg,
                confirmButtonColor: '#3085d6',
            });
        }
    });
}
 function warna_duedate() {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Normalisasi tanggal
    
    // Cek semua elemen due date
    document.querySelectorAll('.tanggal_due_date').forEach(td => {
        const dueDateStr = td.getAttribute('data-due-date');
        if (!dueDateStr) return;
        
        const dueDate = new Date(dueDateStr);
        dueDate.setHours(0, 0, 0, 0); // Normalisasi tanggal
        
        // Hitung selisih hari
        const timeDiff = dueDate - today;
        const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
        
        // Tambahkan class sesuai kondisi
        if (daysDiff < 0) {
            td.classList.add('bg-danger'); // Sudah lewat due date
        } else if (daysDiff <= 7) {
            td.classList.add('bg-warning'); // Dalam 7 hari sebelum due date
        }
    });
}
document.addEventListener('DOMContentLoaded', function() {
    const radioButtons = document.querySelectorAll('input[name="status"]');
    const keteranganContainer = document.getElementById('keteranganContainer');
    
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'revisi' && this.checked) {
                keteranganContainer.style.display = 'block';
            } else {
                keteranganContainer.style.display = 'none';
            }
        });
    });
});
  </script>
{% endblock %}
