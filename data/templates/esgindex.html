{% extends 'base.html' %}

{% block title %}
  {{ title }}
{% endblock %}

{% block head %}
  <style type="text/css">
    .Sidebar .nav-link span {
      transition: all 0.2s ease;
    }
  </style>
{% endblock %}

{% block content %}
  {% comment %}Section header{% endcomment %}
  <section>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12 col-sm-12 p-0">
          <section class="section esg-hero-idx" id="hero" style="background-image: url('{{ imgurl }}');  background-position: center right;">
            <div class="bg-overlay"></div>
            <div class="container-fluid">
              <div class="row">
                <div class="col-lg-7 col-sm-10">
                  <div class="p-5">
                    <h1 class="display-8 fw-medium mb-4 lh-base text-white">{{ title }}</h1>
                    <p class="card-text text-white mb-2 pb-4">{{ subtitle }}</p>
                    <hr style="color: #fff;" />
                    <a type="button" href="dashboard" class="btn btn-outline-success rounded-3 waves-effect waves-light shadow-none text-white mt-4">Go to Dashboard</a>
                    {% if category == 'env' %}
                      <a type="button" href="data/category/soc" class="btn btn-outline-success rounded-3 waves-effect waves-light shadow-none text-white mt-4">Go to Social Working Paper</a>
                      <a type="button" href="data/category/gov" class="btn btn-outline-success rounded-3 waves-effect waves-light shadow-none text-white mt-4">Go to Governance Working Paper</a>
                    {% elif category == 'gov' %}
                      <a type="button" href="data/category/env" class="btn btn-outline-success rounded-3 waves-effect waves-light shadow-none text-white mt-4">Go to Environment Working Paper</a>
                      <a type="button" href="data/category/soc" class="btn btn-outline-success rounded-3 waves-effect waves-light shadow-none text-white mt-4">Go to Social Working Paper</a>
                    {% elif category == 'soc' %}
                      <a type="button" href="data/category/env" class="btn btn-outline-success rounded-3 waves-effect waves-light shadow-none text-white mt-4">Go to Environment Working Paper</a>
                      <a type="button" href="data/category/gov" class="btn btn-outline-success rounded-3 waves-effect waves-light shadow-none text-white mt-4">Go to Governance Working Paper</a>
                    {% endif %}
                  </div>
                </div>
                <!-- end col -->
              </div>
              <!-- end row -->
            </div>
            <!-- end container -->
          </section>
        </div>
      </div>
    </div>
  </section>
  {% comment %}Section navbar{% endcomment %}
  <section>
    <div class="container-fluid">
      <div class="d-flex">
        <div class="flex-grow-1">
          <div class="row">
            <div class="col-md-3 p-5">
              <h1 class="heading-txt fw-semibold">Working Paper</h1>
            </div>
            <div class="col-md-1 pt-5">
              <div id="yearChoicesContainer">
                <select name="year_choose" id="year_choose" class="form-select border-success rounded-4 waves-effect waves-light shadow-none">
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="flex-shrink-0">
          <div class="d-flex flex-wrap gap-2 p-5">
              <a href="javascript:;" class="btn btn-success active d-none" id="btnAdd" ><span class="icon-on"><i class="ri-add-line align-bottom me-1"></i> Add New Working Paper</span></a>
              {% if category == 'env' %}
              <a href="javascript:;" class="btn btn-success active" onclick="upload_enviro()" ><span class="icon-on"><i class="ri-file-upload-line align-bottom me-1"></i> Upload Environment</span></a>
              {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>
  {% comment %}section content{% endcomment %}
  <section>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">
          <!-- Nav tabs -->
          <ul class="nav nav-tabs nav-tabs-custom nav-success nav-justified mb-3" role="tablist">
            <li class="nav-item nav-item-menuinj">
              <a class="nav-link {% if request.session.selected_pic == 1 %}active{% endif %}"  data-bs-toggle="tab" href="javascript:;" onclick="change_pic(1)" role="tab"><img src="{% if request.session.selected_pic == 1 %}assets/images/injourney.png{% else %}assets/images/injourney-white.png{% endif %}" data-default="" data-active="assets/images/injourney.png" class="card-logo" height="40" /></a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.session.selected_pic == 2 %}active{% endif %}" data-bs-toggle="tab" href="javascript:;" onclick="change_pic(2)" role="tab"><img src="{% if request.session.selected_pic == 2 %}assets/images/logotab/inj-airport-act.png{% else %}assets/images/logotab/inj-airport-white.png{% endif %}" class="card-logo" /></a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.session.selected_pic == 3 %}active{% endif %}" data-bs-toggle="tab" href="javascript:;" onclick="change_pic(3)" role="tab"><img src="{% if request.session.selected_pic == 3 %}assets/images/logotab/inj-aviation-act.png{% else %}assets/images/logotab/inj-aviation-white.png{% endif %}" class="card-logo" /></a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.session.selected_pic == 4 %}active{% endif %}" data-bs-toggle="tab" href="javascript:;" onclick="change_pic(4)" role="tab"><img src="{% if request.session.selected_pic == 4 %}assets/images/logotab/inj-retaiil-act.png{% else %}assets/images/logotab/inj-retail-white.png{% endif %}" class="card-logo" /></a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.session.selected_pic == 5 %}active{% endif %}" data-bs-toggle="tab" href="javascript:;" onclick="change_pic(5)" role="tab"><img src="{% if request.session.selected_pic == 5 %}assets/images/logotab/inj-hospi-act.png{% else %}assets/images/logotab/inj-hospi-white.png{% endif %}" class="card-logo" /></a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.session.selected_pic == 6 %}active{% endif %}" data-bs-toggle="tab" href="javascript:;" onclick="change_pic(6)" role="tab"><img src="{% if request.session.selected_pic == 6 %}assets/images/logotab/inj-desti-ac.png{% else %}assets/images/logotab/inj-desti-white.png{% endif %}" class="card-logo" /></a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.session.selected_pic == 7 %}active{% endif %}" data-bs-toggle="tab" href="javascript:;" onclick="change_pic(7)" role="tab"><img src="{% if request.session.selected_pic == 7 %}assets/images/logotab/inj-touris-act.png{% else %}assets/images/logotab/inj-tourisn-white.png{% endif %}" class="card-logo" /></a>
            </li>
          </ul>

          <div class="row p-2">
            <!--         This particular code snippet is creating a sidebar navigation menu with tabs. Here's a
             breakdown of what each part does:         -->
            {% comment %} <div class="col-md-3">
              <!-- Nav tabs -->
              <ul class="nav flex-column nav-tabs nav-success mb-3 Sidebar" role="tablist" aria-orientation="horizontal">
                {% for submenus in submenulist %}
                  <li class="nav-item nav-item-menuinj">
                    <a class="nav-link" data-bs-toggle="tab" href="" onclick="get_data(1)" role="tab">{{ submenus.indicator }}</a>
                  </li>
                {% endfor %}
              </ul>
            </div> {% endcomment %}
            <div class="col-md-3">
              <ul class="nav flex-column nav-tabs nav-success mb-3 Sidebar" role="tablist" aria-orientation="horizontal">
                {% for submenu in submenulist %}
                  <li class="nav-item nav-item-menuinj">
                    <a class="nav-link" href="#sidebar{{ submenu.id }}" aria-expanded="false" data-bs-toggle="collapse" role="tab">{{ submenu.indicator }}</a>
                    <div class="collapse menu-dropdown p-3" id="sidebar{{ submenu.id }}">
                      <ul class="nav nav-sm flex-column">
                        {% for kriteria in submenu.kriteria %}
                          <li class="nav-item">
                            <a href="javascript:;" class="nav-link" onclick="get_data('{{ category }}',{{ submenu.id }},{{ kriteria.id }},'{{ submenu.indicator }}','{{ kriteria.kriteria }}')">{{ kriteria.kriteria }}</a>
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  </li> <!-- end Dashboard Menu -->
                {% endfor %}
              </ul>
            </div>

            <div class="col-md-9">
              <div class="row">
                <h2 class="pt-3" id="indtitle"></h2>
                <h4 class="pt-3" id="subtitle"></h4>
                <div id="cardlevel">
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <div class="modal fade" id="uploadEnviro" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl ">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="myModalLabel">Upload Data Environment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
        </div>
        <form action="" method="post" enctype="multipart/form-data">  
        {% csrf_token %}
        <div class="modal-body">
          <div class="row">
            <div class="col-xxl-6 col-md-6 mt-3">
              <label for="3" class="form-label">Entity</label>
              <select id="entity_select" class="form-control" name="pic">
                <option value="" disabled selected>Choose Entity</option>
                {% for ent in entity %}
                  <option value="{{ ent.id }}">{{ ent.pic }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-xxl-6 col-md-6 mt-3">
              <label for="3" class="form-label">Group</label>
              <select id="group_select" class="form-control" name="group">
                <option value="" disabled selected>Choose Group</option>
              </select>
            </div>
            <div class="col-xxl-6 col-md-6 mt-3">
              <label for="3" class="form-label">Location</label>
              <select id="location_select" class="form-control" name="location">
                <option value="" disabled selected>Choose Location</option>
              </select>
            </div>
          </div>
          <div class="mt-3">
            <div class="dropzone" id="dropzoneData">
              <div class="fallback">
                <input name="file" type="file" multiple="multiple" />
              </div>

              <div class="dz-message needsclick">
                <div class="mb-3">
                  <i class="display-4 text-muted ri-upload-cloud-2-fill"></i>
                </div>
                <h4>Drop files here or click to upload.</h4>
              </div>
            </div>

            <ul class="list-unstyled mb-0" id="dropzone-preview-data">
              <li class="mt-2" id="dropzone-preview-list-data">
                <!-- TEMPLATE PREVIEW -->
                <div class="border rounded">
                  <div class="d-flex p-2">
                    <div class="flex-shrink-0 me-3">
                      <div class="avatar-sm bg-light rounded">
                        <img data-dz-thumbnail class="img-fluid rounded d-block" src="assets/images/new-document.png" alt="Dropzone-Image" />
                      </div>
                    </div>

                    <div class="flex-grow-1">
                      <div class="pt-1">
                        <h5 class="fs-14 mb-1" data-dz-name>&nbsp;</h5>
                        <p class="fs-13 text-muted mb-0" data-dz-size></p>
                        <strong class="error text-danger" data-dz-errormessage></strong>
                      </div>
                    </div>

                    <div class="flex-shrink-0 ms-3">
                      <button data-dz-remove class="btn btn-sm btn-danger">Delete</button>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success active" id="submit-all"><span class="icon-on"><i class="bx bx-save large"></i> Simpan</span></button>
        </div>
        </form>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
{% endblock %}
{% block script %}
  <script type="text/javascript">
    {% comment %} document.querySelectorAll('.nav-link').forEach((link) => {
      link.addEventListener('shown.bs.tab', function () {
        document.querySelectorAll('.nav-link img').forEach((img) => {
          img.src = img.getAttribute('data-default')
        })
    
        let img = this.querySelector('img')
        img.src = img.getAttribute('data-active')
      })
    }) {% endcomment %}
  </script>
  <script>
    const choice_option = {
      searchResultLimit: 20,
      shouldSort: false
    }
    const entity_select = new Choices('#entity_select', choice_option)
    const group_select = new Choices('#group_select', choice_option)
    const location_select = new Choices('#location_select', choice_option)
    
    function upload_enviro(){
      $('#uploadEnviro').modal('show')
    }

    $('#entity_select').change(function () {
      choose = entity_select.getValue().value
      $.ajax({
        url: `master/get_group_pic/${choose}`,
        dataType: 'json',
        async: true,
        success: (res) => {
          if (res.data.length > 0){
            group_select.clearChoices()
            group_select.removeActiveItems()
            var grp_opt = []
            grp_opt.push({
              value: '',
              label: 'Choose Group',
              selected: true,
              disabled: true
            })
            for (var i = 0; i < res.data.length; i++) {
              const dt = res.data[i]
              grp_opt.push({
                value: dt.id,
                label: dt.group
              })
            }
            group_select.setChoices(grp_opt, 'value', 'label', false)
            location_select.clearChoices()
            location_select.removeActiveItems()
            var loc_opt = []
            loc_opt.push({
              value: '',
              label: 'Choose Location',
              selected: true,
              disabled: true
            })
            location_select.setChoices(loc_opt, 'value', 'label', false)
          } else {
            group_select.clearChoices()
            group_select.removeActiveItems()
            var grp_opt = []
            grp_opt.push({
              value: '',
              label: 'Choose Group',
              selected: true,
              disabled: true
            })
            group_select.setChoices(grp_opt, 'value', 'label', false)
            $.ajax({
              url: `master/get_location/${choose}`,
              dataType: 'json',
              async: true,
              success: (res) => {
                location_select.clearChoices()
                location_select.removeActiveItems()
                var loc_opt = []
                loc_opt.push({
                  value: '',
                  label: 'Choose Location',
                  selected: true,
                  disabled: true
                })
                for (var i = 0; i < res.data.length; i++) {
                  const dt = res.data[i]
                  loc_opt.push({
                    value: dt.id,
                    label: dt.location
                  })
                }
                location_select.setChoices(loc_opt, 'value', 'label', false)
              }
            })
          }
          
        }
      })
    })

    $('#group_select').change(function () {
      ent = entity_select.getValue().value
      grp = group_select.getValue().value
      $.ajax({
        url: `master/get_location/${ent}/${grp}`,
        dataType: 'json',
        async: true,
        success: (res) => {
          location_select.clearChoices()
          location_select.removeActiveItems()
          var loc_opt = []
          loc_opt.push({
            value: '',
            label: 'Choose Location',
            selected: true,
            disabled: true
          })
          for (var i = 0; i < res.data.length; i++) {
            const dt = res.data[i]
            loc_opt.push({
              value: dt.id,
              label: dt.location
            })
          }
          location_select.setChoices(loc_opt, 'value', 'label', false)
        }
      })
    })

    Dropzone.autoDiscover = false;

    var previewNodeData = document.querySelector("#dropzone-preview-list-data");
    previewNodeData.id = ""; 
    var previewTemplateData = previewNodeData.parentNode.innerHTML;
    previewNodeData.parentNode.removeChild(previewNodeData);

    var myDropzone = new Dropzone("#dropzoneData", {
        url: "data/uploadenviro/",
        paramName: "file",
        maxFilesize: 5, // MB
        acceptedFiles: ".xlsx,.xls",
        previewsContainer: "#dropzone-preview-data",
        previewTemplate: previewTemplateData,
        parallelUploads: 2,
        addRemoveLinks: false,
        autoProcessQueue: false,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        init: function() {
            const submitButton = document.querySelector("#submit-all");
            const dz = this;
            
            const form = document.querySelector("#uploadEnviro form");
            form.addEventListener("submit", function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Validasi form
                const entity = entity_select.getValue().value;
                const group = group_select.getValue().value;
                const location = location_select.getValue().value;
                
                // Tampilkan loading
                submitButton.innerHTML = '<i class="bx bx-loader bx-spin"></i> Uploading...';
                submitButton.disabled = true;
                
                // Process semua file di queue
                dz.processQueue();
            });
            
            // Saat semua file berhasil diupload
            this.on("queuecomplete", function() {
                if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
                    // Reset button
                    submitButton.innerHTML = '<i class="bx bx-save large"></i> Simpan';
                    submitButton.disabled = false;
                    
                    // Tutup modal
                    $('#uploadEnviro').modal('hide');
                    
                    // Reset form
                    entity_select.clearChoices();
                    group_select.clearChoices();
                    location_select.clearChoices();
                    dz.removeAllFiles(true);
                    
                    // Refresh halaman atau data
                    window.location.reload();
                }
            });
            
            // Saat terjadi error
            this.on("error", function(file, errorMessage) {
                alert('Error uploading file: ' + errorMessage);
                this.removeFile(file);
                
                // Reset button
                submitButton.innerHTML = '<i class="bx bx-save large"></i> Simpan';
                submitButton.disabled = false;
            });
            
            // Saat mengirim file
            this.on("sending", function(file, xhr, formData) {
                // Tambahkan data form ke setiap file yang diupload
                const entity = entity_select.getValue().value;
                const group = group_select.getValue().value;
                const location = location_select.getValue().value;
                
                formData.append('entity', entity);
                formData.append('group', group);
                formData.append('location', location);
                
                // Tambahkan CSRF token
                formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            });
        },
        error: function(file, message) {
          alert('Error: ' + message);
          this.removeFile(file);
        }
    });

    document.querySelector("#uploadEnviro form").addEventListener("submit", function(e) {
      e.preventDefault();
      return false;
    });
    
    document.addEventListener('DOMContentLoaded', function () {
      const navLinks = document.querySelectorAll('.Sidebar .nav-link')
    
      navLinks.forEach((link) => {
        link.addEventListener('click', function () {
          navLinks.forEach((l) => {
            l.classList.remove('active')
            l.classList.add('text-muted')
    
            const iconSpan = l.querySelector('span')
            if (iconSpan) iconSpan.remove()
          })
    
          this.classList.add('active')
          this.classList.remove('text-muted')
    
          const arrow = document.createElement('span')
          arrow.innerHTML = `<i class="ri-arrow-right-line align-bottom me-1"></i>`
          this.prepend(arrow)
        })
      })
    })
    function getCookie(name) {
      let cookieValue = null
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';')
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim()
          if (cookie.substring(0, name.length + 1) === name + '=') {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
            break
          }
        }
      }
      return cookieValue
    }
    function add_data(category,indicator, subindicator){
      {% comment %} console.log(category)
      console.log(indicator)
      console.log(subindicator) {% endcomment %}
      $.ajax({
        url: `data/add_data/${indicator}/${subindicator}`,
        dataType: 'json',
        async: true,
        success:(res) => {
          {% comment %} console.log(res) {% endcomment %}
          data = res.data
          {% comment %} console.log(data) {% endcomment %}
          window.location.href = `data/workpaper_form?cat=${category}&ind=${indicator}&sub=${subindicator}&id=${data}`
        }
      }) 
    }
    function get_data(category,indicator, subindicator, indtittle, subtitle) {
      $.ajax({
        url: `data/get_data/${indicator}/${subindicator}`,
        dataType: 'json',
        async: true,
        success: (res) => {
          console.log(res)
          $('#indtitle').html(indtittle)
          $('#subtitle').html(subtitle)
          data=res.data
          count=res.counting_detail
          const link = document.getElementById('btnAdd');
          if(count < 3){
            $('#btnAdd').removeClass('d-none');
            $('#btnAdd').attr('onclick', `add_data('${category}','${indicator}','${subindicator}')`)
          } else {
            $('#btnAdd').addClass('d-none');
          }
          let mode = "edit";
          let html = "";
            for (let i = 0; i < data.length; i++) { 

              let lastLevel = count;
              let deleteClass = null
              if(data[i].level == lastLevel) {
                deleteClass = ''
              }
              else{
                deleteClass = 'd-none'
              }

              html += `
                <div class="card">
                        <div class="card-header">
                          <div class="row">
                            <div class="col-md-10">
                              <h6 class="card-title mb-0">Level ${data[i].level}</h6>
                            </div>
                            <div class="col-md-2">
                              <div class="btn-group" style="float: right;">
                                <a class="fs-20" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span><i class="ri-more-fill align-bottom me-1"></i></span></a>
                                <div class="dropdown-menu">
                                  <a class="dropdown-item" href="data/detail?category={{category}}&ind=${indicator}&sub=${data[i].kriteria_id}&matlev=${data[i].id}"><i class="ri-folder-2-line"></i> Detail</a>
                                  <a class="dropdown-item" href="data/edit?id=${data[i].id}&category={{category}}&mode=${mode}"><i class="ri-edit-box-line"></i> Edit</a>
                                  <a class="dropdown-item ${deleteClass}" href="javascript:;" onclick="delete_data(${data[i].id})"><i class="ri-delete-bin-line"></i> Delete</a>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="card-body">
                          <p class="card-text">${data[i].maturity}</p>
                        </div>
                      </div>
              `
            }
            $('#cardlevel').html(html)
        }
      }) 
    }
    function delete_data(id){
        Swal.fire({
        title: 'Are you sure?',
        text: 'Deleted data cannot be recovered!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#020202ff',
        confirmButtonText: 'Yes, Delete!',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: `data/delete/${id}`,
            success: (res) => {
              if (res.success) {
                Swal.fire('Deleted!', 'Data has been successfully deleted.', 'success').then(function () {
                  window.location.reload();
                })
              } else {
                Swal.fire('Failed!', res.message || 'An error occurred while deleting the data.', 'error')
              }
            },
            error: (err) => {
              Swal.fire('Error!', 'Unable to delete the data. Please try again.', 'error')
            }
          })
        }
      })
    }

    function change_pic(pic) {
      $.ajax({
        url: `change_pic/${pic}`,
        dataType: 'json',
        async: true,
        success:(res) => {
          window.location.reload()
        }
      })
    }
  </script>
{% endblock %}
